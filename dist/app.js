(function(){var e,o,r,n,i,s;n=require("./crawler"),r=require("./config"),s=require("mongoose"),o=require("./models").User,e=require("./models").Record,r=require("./config"),s.Promise=require("bluebird"),s.connect(r.DB_ADDR),i=function(){console.log("...listening for changes..."),o.find({}).populate("log_history").exec(function(o,i){return o?console.error(o):n(r.ROUTER_IP,function(o){var r,n,s,t,g,c;for(r=0,s=i.length;s>r;r++)for(c=i[r],n=0,t=o.length;t>n;n++)g=o[n],c.mac_address===g.mac_address&&!function(o,r){var n;o.log_history.length<1?(n=new e({}),n.save().then(function(){return o.log_history.push(n._id),o.save()}).then(function(){console.log("created first record for user: ",o.nome,new Date)})):o.log_history[o.log_history.length-1].isLogged!==r.isLogged&&(n=new e({isLogged:r.isLogged}),n.save().then(function(){return o.log_history.push(n._id),o.save()}).then(function(){console.log("user ",o.nome," log status: ",r.isLogged)}))}(c,g)})})},setInterval(function(){i()},r.INTERVAL)}).call(this);